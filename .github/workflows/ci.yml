name: 'Project CI/CD Pipeline'

on: [push, pull_request]

jobs:
  # =========================================================
  # Job 1: Build, Lint, Test, and Security Scan
  # =========================================================
  build-and-test:
    name: 'Build, Lint, Test & Scan'
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./react_ak

    steps:
      - name: 'Checkout Repository'
        uses: actions/checkout@v4

      - name: 'Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'yarn'
          cache-dependency-path: react_ak/yarn.lock

      # ---------------- BUILD ----------------
      - name: 'Install Dependencies'
        run: yarn install --frozen-lockfile

      - name: 'Run Build Script'
        run: yarn build

      # ---------------- TEST ----------------
      - name: 'Run Tests & Generate Coverage'
        run: yarn test --coverage
        continue-on-error: false

      - name: 'Upload Coverage Report'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: react_ak/coverage/

      # ---------------- LINT ----------------
      - name: 'Run Lint Check'
        run: yarn lint > ../lint-report.txt 2>&1
        continue-on-error: true

      - name: 'Upload Lint Report'
        uses: actions/upload-artifact@v4
        with:
          name: lint-report
          path: lint-report.txt

      # ---------------- SECURITY ----------------
      - name: 'Run Security Scan (yarn audit)'
        run: yarn audit --json > ../security-report.json
        continue-on-error: true

      - name: 'Upload Security Report'
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security-report.json

  # =========================================================
  # Job 2: Package and Upload Deployment Artifact
  # =========================================================
  package-artifact:
    name: 'Create Deployment Artifact'
    runs-on: ubuntu-latest
    needs: [build-and-test]

    steps:
      - name: 'Checkout Repository'
        uses: actions/checkout@v4

      # Download all reports from previous job
      - name: 'Download Lint Report'
        uses: actions/download-artifact@v4
        with:
          name: lint-report
          path: reports/lint

      - name: 'Download Security Report'
        uses: actions/download-artifact@v4
        with:
          name: security-report
          path: reports/security

      - name: 'Download Coverage Report'
        uses: actions/download-artifact@v4
        with:
          name: coverage-report
          path: reports/coverage

      # ---------------- PACKAGE ----------------
      - name: 'Create Deployment Package'
        run: |
          mkdir -p deployment-package/src
          cp -r react_ak/src/* deployment-package/src/
          cp react_ak/package.json react_ak/yarn.lock deployment-package/
          cp README.md deployment-package/
          cp -r reports deployment-package/
          cd deployment-package
          zip -r ../deployment-package.zip .

      # ---------------- UPLOAD ----------------
      - name: 'Upload Final Deployment Artifact'
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: deployment-package.zip
