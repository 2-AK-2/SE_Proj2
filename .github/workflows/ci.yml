name: "Cabify CI/CD Pipeline"

on:
  push:
  pull_request:

jobs:
  # ===============================
  # 1️⃣ BUILD + TEST + COVERAGE + LINT + SECURITY
  # ===============================
  quality-checks:
    name: "Build • Test • Coverage • Lint • Security"
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: react_ak/frontend

    steps:
      # -- CHECKOUT
      - name: Checkout Repository
        uses: actions/checkout@v4

      # -- SETUP NODE
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
          cache-dependency-path: react_ak/frontend/package-lock.json

      # -- INSTALL DEPENDENCIES
      - name: Install Dependencies
        run: npm ci

      # -- BUILD
      - name: Build Project
        run: npm run build

      # -- TEST & COVERAGE
      - name: Run Tests with Coverage
        run: npm test -- --coverage || true

      # Upload Coverage Report
      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: react_ak/frontend/coverage/

      # -- LINT
      - name: Run ESLint
        run: |
          npm run lint > ../../lint-report.txt 2>&1 || true

      - name: Upload Lint Report
        uses: actions/upload-artifact@v4
        with:
          name: lint-report
          path: lint-report.txt

      # -- SECURITY SCAN
      - name: Security Scan (npm audit)
        run: |
          npm audit --json > ../../security-report.json || true

      - name: Upload Security Report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security-report.json

  # ===============================
  # 2️⃣ DEPLOYMENT ARTIFACT
  # ===============================
  package-artifact:
    name: "Create Deployment Artifact"
    runs-on: ubuntu-latest
    needs: [quality-checks]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Download all CI reports
      - uses: actions/download-artifact@v4
        with:
          name: coverage-report
          path: reports/coverage

      - uses: actions/download-artifact@v4
        with:
          name: lint-report
          path: reports/lint

      - uses: actions/download-artifact@v4
        with:
          name: security-report
          path: reports/security

      # Create ZIP Deployment Package
      - name: Generate Deployment Package
        run: |
          mkdir -p deployment/src
          cp -r react_ak/frontend/src deployment/
          cp react_ak/frontend/package.json react_ak/frontend/package-lock.json deployment/
          cp -r reports deployment/reports
          cp README.md deployment/
          cd deployment
          zip -r ../deployment-package.zip .

      # Upload Final Artifact
      - uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: deployment-package.zip
