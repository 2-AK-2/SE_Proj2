name: 'Project CI/CD Pipeline'

on: [push, pull_request]

jobs:
  # ======================================
  # JOB 1: BUILD, LINT, TEST, SECURITY SCAN
  # ======================================
  build-and-test:
    name: 'Build, Lint, Test & Scan'
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./react_ak/frontend   # Path to frontend

    steps:
      # --- CHECKOUT REPO ---
      - name: 'Checkout Repository'
        uses: actions/checkout@v4

      # --- SETUP NODE ---
      - name: 'Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: react_ak/frontend/package-lock.json

      # --- INSTALL DEPENDENCIES ---
      - name: 'Install Dependencies'
        run: npm ci

      # --- BUILD PROJECT ---
      - name: 'Run Build Script'
        run: npm run build

      # --- TEST & COVERAGE ---
      - name: 'Run Tests & Generate Coverage'
        run: npm test -- --coverage
        continue-on-error: true

      - name: 'Upload Coverage Report'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: react_ak/frontend/coverage/   # Path where coverage is created

      # --- LINT (FRONTEND: ESLINT) ---
      - name: 'Run Lint Check (ESLint)'
        run: |
          npm run lint --max-warnings=0 > ../lint-report.txt 2>&1 || true
        continue-on-error: true

      - name: 'Upload Lint Report'
        uses: actions/upload-artifact@v4
        with:
          name: lint-report
          path: react_ak/lint-report.txt       # ✅ PATCHED PATH

      # --- SECURITY SCAN ---
      - name: 'Run Security Scan (npm audit)'
        run: |
          npm audit --json > ../security-report.json || true
        continue-on-error: true

      - name: 'Upload Security Report'
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: react_ak/security-report.json  # ✅ PATCHED PATH

  # ======================================
  # JOB 2: PACKAGE DEPLOYMENT ARTIFACT
  # ======================================
  package-artifact:
    name: 'Create Deployment Artifact'
    runs-on: ubuntu-latest
    needs: [build-and-test]

    steps:
      - name: 'Checkout Repository'
        uses: actions/checkout@v4

      # Download all previous reports
      - name: 'Download Lint Report'
        uses: actions/download-artifact@v4
        with:
          name: lint-report
          path: reports/lint

      - name: 'Download Security Report'
        uses: actions/download-artifact@v4
        with:
          name: security-report
          path: reports/security

      - name: 'Download Coverage Report'
        uses: actions/download-artifact@v4
        with:
          name: coverage-report
          path: reports/coverage

      # Create final ZIP
      - name: 'Create Deployment Package'
        run: |
          mkdir -p deployment-package/src
          cp -r react_ak/frontend/src/* deployment-package/src/
          cp react_ak/frontend/package.json react_ak/frontend/package-lock.json deployment-package/
          cp README.md deployment-package/
          cp -r reports deployment-package/
          zip -r deployment-package.zip deployment-package
      
      - name: 'Upload Final Deployment Artifact'
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: deployment-package.zip
