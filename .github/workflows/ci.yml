name: 'Project CI/CD Pipeline'

on: [push, pull_request]

# Set the default working directory for all jobs to './react'
defaults:
  run:
    working-directory: ./react

jobs:
  # Job 1: Build, Lint, Test, and Scan
  build-and-test:
    name: 'Build, Lint, Test & Scan'
    runs-on: ubuntu-latest

    steps:
      - name: 'Checkout Repository'
        uses: actions/checkout@v4

      - name: 'Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'yarn'
          # This is the corrected line, pointing to the yarn.lock file
          cache-dependency-path: react/yarn.lock

      # --- STAGE 1: BUILD ---
      - name: 'Install Dependencies'
        # Use yarn install, which is the equivalent of 'npm ci'
        run: yarn install --frozen-lockfile

      - name: 'Run Build Script'
        run: yarn build

      # --- STAGE 2 & 3: TEST & COVERAGE ---
      - name: 'Run Tests & Generate Coverage'
        run: yarn test --coverage
        # Make sure you add the coverageThreshold to your react/package.json
        # "jest": { "coverageThreshold": { "global": { "lines": 75 }}}

      - name: 'Upload Coverage Report (Artifact 1)'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: react/coverage/

      # --- STAGE 4: LINT ---
      - name: 'Run Lint Check'
        run: yarn lint --output-file ../lint-report.txt --format=checkstyle
        continue-on-error: true # Continue so we can upload the report

      - name: 'Upload Lint Report (Artifact 2)'
        uses: actions/upload-artifact@v4
        with:
          name: lint-report
          path: lint-report.txt

      # --- STAGE 5: SECURITY ---
      - name: 'Run Security Scan (yarn audit)'
        # Run audit and save the JSON report
        # Note: yarn audit has different output, we'll pipe it
        run: yarn audit --json > ../security-report.json
        continue-on-error: true # Continue so we can upload the report

      - name: 'Upload Security Report (Artifact 3)'
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security-report.json

  # --- CD STAGE: DEPLOYMENT ARTIFACT ---
  package-artifact:
    name: 'Create Deployment Artifact'
    runs-on: ubuntu-latest
    needs: [build-and-test]

    steps:
      - name: 'Checkout Repository'
        uses: actions/checkout@v4

      # Download all the reports we saved earlier
      - name: 'Download Lint Report'
        uses: actions/download-artifact@v4
        with:
          name: lint-report
          path: reports/lint
      - name: 'Download Security Report'
        uses: actions/download-artifact@v4
        with:
          name: security-report
          path: reports/security
      - name: 'Download Coverage Report'
        uses: actions/download-artifact@v4
        with:
          name: coverage-report
          path: reports/coverage

      # Create the final zip file
      - name: 'Create Deployment Package'
        run: |
          mkdir -p deployment-package/src
          # Copy source code, readme, and package files
          cp -r react/src/* deployment-package/src/
          cp react/package.json react/yarn.lock deployment-package/
          cp README.md deployment-package/
          # Copy all the reports
          cp -r reports deployment-package/
          # Zip it all up
          zip -r deployment-package.zip deployment-package
      
      - name: 'Upload Final Deployment Artifact (Rubric Goal)'
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: deployment-package.zip